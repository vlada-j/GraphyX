"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function s(t,e,s){return e&&i(t.prototype,e),s&&i(t,s),t}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function h(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,s=o(t);if(e){var n=o(this).constructor;i=Reflect.construct(s,arguments,n)}else i=s.apply(this,arguments);return a(this,i)}}function c(t,e,i){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var s=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=o(t)););return t}(t,e);if(s){var n=Object.getOwnPropertyDescriptor(s,e);return n.get?n.get.call(i):n.value}})(t,e,i||t)}var u=function(){function t(){e(this,t),this._listeners={}}return s(t,[{key:"addEventListener",value:function(t,e){void 0===this._listeners[t]&&(this._listeners[t]=[]),-1===this._listeners[t].indexOf(e)&&this._listeners[t].push(e)}},{key:"hasEventListener",value:function(t,e){return void 0!==this._listeners[t]&&-1!==this._listeners[t].indexOf(e)}},{key:"removeEventListener",value:function(t,e){var i=this._listeners[t];if(void 0!==i){var s=i.indexOf(e);-1!==s&&i.splice(s,1)}}},{key:"dispatchEvent",value:function(t){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=e.slice(0),s=0,n=i.length;s<n;s++)i[s].call(this,t)}}}]),t}();function l(t){this.sprite=t.sprite,this.fill=t.fill||"transparent",this.stroke=t.stroke||"transparent",this.line=t.line||1,this.x=t.x||0,this.y=t.y||0,this.r=t.r||0,this.opacity=t.opacity||1,this.shadow=t.shadow||!1}l.prototype={constructor:l,transform:function(t){this.sprite=t||this.sprite,this.sprite.translate(this.x,this.y),this.sprite.rotate(this.r),this.sprite.translate(-this.x,-this.y)},stylize:function(t){this.sprite=t||this.sprite,this.sprite.fillStyle=this.fill,this.sprite.strokeStyle=this.stroke,this.sprite.lineWidth=this.line,this.sprite.globalAlpha=this.opacity,this.shadow&&(this.sprite.shadowColor=this.shadow.color,this.sprite.shadowBlur=this.shadow.blur,this.sprite.shadowOffsetX=this.shadow.x,this.sprite.shadowOffsetY=this.shadow.y)},draw:function(t){this.sprite=t||this.sprite,null!==this.stroke&&this.sprite.stroke(),this.fill instanceof window.HTMLImageElement?(this.sprite.clip(),this.sprite.drawImage(this.fill,this.x-this.fill.width/2,this.y-this.fill.height/2)):null!==this.fill&&this.sprite.fill()},render:function(t){this.sprite=t||this.sprite,this.sprite.save(),this.transform(t),this.stylize(t),this.shaped(t),this.draw(t),this.sprite.restore()},shaped:function(){}};var p=function(t){n(o,u);var i=h(o);function o(t){var s;return e(this,o),(s=i.call(this))._settings=t,s._canvas=null,s._sprite=null,s.CANVAS_WIDTH=0,s.CANVAS_HEIGHT=0,s._zoom=1,s._pan={x:0,y:0},s._isRun=!1,s._lastTimestamp=0,s._fps=0,s._followingTarget=null,s._onUpdate=function(){},s.objects=[],s.init(),s}return s(o,[{key:"init",value:function(){var t,e,i=this._settings;e=(t="string"==typeof i.canvas?document.querySelector(i.canvas):i.canvas).getContext("2d"),this.CANVAS_WIDTH=t.width,this.CANVAS_HEIGHT=t.height,this._zoom=i.zoom||this._zoom,this._pan={x:this.CANVAS_WIDTH/2,y:this.CANVAS_HEIGHT/2},this._settings=i,this._canvas=t,this._sprite=e,this._isRun=!1}},{key:"resize",value:function(t,e){this._canvas.width=this.CANVAS_WIDTH=t,this._canvas.height=this.CANVAS_HEIGHT=e,this._pan={x:t/2,y:e/2}}},{key:"start",value:function(){this._isRun||(this._isRun=!0,this._lastTimestamp=(new Date).getTime(),this.loop())}},{key:"stop",value:function(){this._isRun=!1}},{key:"loop",value:function(){var t=this,e=(new Date).getTime(),i=e-this._lastTimestamp;this._fps=parseInt(1e3/i),this._lastTimestamp=e,this._isRun&&window.requestAnimationFrame((function(){t.loop.call(t)})),this.refresh(i)}},{key:"onUpdate",value:function(t){var e=this._onUpdate;this._onUpdate=function(){e(),"function"==typeof t&&t()}}},{key:"draw",value:function(){var t=this;t.objects instanceof Array&&t.objects.forEach((function(e){e instanceof l&&e.render(t._sprite)}))}},{key:"clear",value:function(){this._sprite.setTransform(1,0,0,1,0,0),"number"==typeof this._fade?(this._sprite.fillStyle="rgba(0,0,0,"+this._fade+")",this._sprite.beginPath(),this._sprite.fillRect(0,0,this.CANVAS_WIDTH,this.CANVAS_WIDTH),this._sprite.closePath(),this._sprite.fill()):this._sprite.clearRect(0,0,this.CANVAS_WIDTH,this.CANVAS_WIDTH),this._followingTarget&&(this._pan.x=this._canvas.width/2-this._followingTarget.x*this._zoom,this._pan.y=this._canvas.height/2-this._followingTarget.y*this._zoom),this._sprite.translate(this._pan.x,this._pan.y),this._sprite.scale(this._zoom,this._zoom)}},{key:"refresh",value:function(t){this.clear(),this.draw(),this.dispatchEvent({type:"update",target:this,delta:t||0,fps:this._fps})}},{key:"scroll",value:function(t,e){if(void 0===t&&void 0===e)return this._pan;"number"==typeof t&&(this._pan.x=t),"number"==typeof e&&(this._pan.y=e),this._isRun||this.refresh()}},{key:"following",value:function(t){if(null===t&&(this._followingTarget=null),!(t instanceof l)&&"number"!=typeof t)return this._followingTarget;"number"==typeof t&&(t=this.objects[t]),this._followingTarget=t}},{key:"zoom",value:function(t){if(void 0===t)return 100*this._zoom;this._zoom=t/100||this._zoom,this._isRun||this.refresh()}},{key:"getCoordinateFrom",value:function(t,e){var i=this._zoom;return{x:(t-this._pan.x)/i,y:(e-this._pan.y)/i}}},{key:"getPixel",value:function(t,e){var i=this._sprite.getImageData(t,e,1,1).data;return{r:i[0],g:i[1],b:i[2],a:i[3]}}}]),o}();function y(t){t=t||{},this.radius=t.radius||10,l.call(this,t)}function f(t){t=t||{},this.width=t.width||20,this.height=t.height||10,l.call(this,t)}function d(t){t=t||{},this.points=t.points||[],l.call(this,t),this.fill=null}function v(t){t=t||{},this.points=t.points||[],d.call(this,t),this.fill=t.fill}function _(t){t=t||{},this.width=t.width||10,this.height=t.height||10,l.call(this,t),t.src instanceof window.HTMLImageElement?this.img=t.src:(this.img=new window.Image(this.width,this.height),this.img.src=t.src||"")}function g(t,e,i){for(var s in t=t||{},e=e||{})e.hasOwnProperty(s)&&(t[s]=m(e[s])?g(t[s],e[s]):void 0===e[s]?t[s]:e[s]);return i&&g(t,i),t}function m(e){return"object"===t(e)&&null!==e&&e.constructor===Object&&"[object Object]"===Object.prototype.toString.call(e)}y.prototype=Object.create(l.prototype),y.prototype.constructor=y,y.prototype.shaped=function(t){this.sprite=t||this.sprite,this.sprite.beginPath(),this.sprite.arc(this.x,this.y,this.radius,0,2*Math.PI),this.sprite.closePath()},f.prototype=Object.create(l.prototype),f.prototype.constructor=f,f.prototype.shaped=function(t){this.sprite=t||this.sprite,this.sprite.beginPath(),this.sprite.rect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),this.sprite.closePath()},d.prototype=Object.create(l.prototype),d.prototype.constructor=d,d.prototype.shaped=function(t){this.sprite=t||this.sprite;var e=this.points;this.sprite.beginPath(),this.sprite.moveTo(this.x+e[0].x,this.y+e[0].y);for(var i=1;i<e.length;i++)this.sprite.lineTo(e[i].x+this.x,e[i].y+this.y)},v.prototype=Object.create(d.prototype),v.prototype.constructor=v,v.prototype.shaped=function(t){this.sprite=t||this.sprite,d.prototype.shaped.call(this),this.sprite.closePath()},_.prototype=Object.create(l.prototype),_.prototype.constructor=_,_.prototype.shaped=function(t){this.sprite=t||this.sprite,this.sprite.drawImage(this.img,this.x-this.img.width/2,this.y-this.img.height/2,this.width,this.height)};var w,b,x,D,S,A,k,T,B,E,C={extend:g,isPlainObject:m,imagesLoader:function(t,e,i){e=e||function(){},i=i||function(){};var s,n={};return(t=t||{})instanceof Array&&(t.forEach((function(t){n[t]=t})),t=n,n={}),s=Object.keys(t).length,Object.keys(t).forEach((function(o){var r=new Image,a=t[o];r.onload=function(){n[o]=r,0===(s-=1)&&e(n)},r.onerror=i,r.src=a})),n}};var O=function(i){n(a,p);var r=h(a);function a(t){var i;return e(this,a),w=Box2D.Common.Math.b2Vec2,b=Box2D.Dynamics.b2World,x=Box2D.Dynamics.b2DebugDraw,D=Box2D.Dynamics.b2Body,S=Box2D.Dynamics.b2BodyDef,A=Box2D.Dynamics.b2FixtureDef,k=Box2D.Collision.Shapes.b2PolygonShape,T=Box2D.Collision.Shapes.b2CircleShape,B=Box2D.Collision.b2AABB,E=Box2D.Dynamics.Joints.b2RevoluteJointDef,t=g({},a.default,t),(i=r.call(this,t)).CANVAS_WIDTH,i.CANVAS_HEIGHT,i.SCALE,i._isRun=!1,i._world,i._boundaries,i._debugDraw,i._control,i}return s(a,[{key:"init",value:function(){var e;c(o(a.prototype),"init",this).call(this);var i=this._settings;e="object"===t(e=i.gravity)?e:{x:0,y:e},e=new w(e.x,e.y),this.SCALE=i.scale,this._settings=i,this._gravity=e,this._isRun=!1,this._debugDrawEnabled=!!i.debugDraw,this._control=this.setDirectControl(),this._control[i.directControl?"turnOn":"turnOff"]()}},{key:"createWorld",value:function(){this._world=new b(this._gravity,!0),this._debugDrawEnabled&&(this._debugDraw=this.createDebugDraw({sprite:this._sprite,scale:this.SCALE,alpha:.5,lineThickness:1}),this._world.SetDebugDraw(this._debugDraw))}},{key:"createWorldBoundaries",value:function(t,e){t=(t||this._canvas.width)/this.SCALE,e=(e||this._canvas.height)/this.SCALE,this._boundaries=this.createBody({x:-t/2,y:-e/2,type:"s"},[{friction:1,shape:{type:"edge",x1:0,y1:0,x2:t,y2:0}},{friction:1,shape:{type:"edge",x1:0,y1:e,x2:t,y2:e}},{friction:1,shape:{type:"edge",x1:0,y1:0,x2:0,y2:e}},{friction:1,shape:{type:"edge",x1:t,y1:0,x2:t,y2:e}}])}},{key:"createDebugDraw",value:function(t){var e=new x;return e.SetSprite(t.sprite),e.SetDrawScale(t.scale),e.SetFillAlpha(t.alpha),e.SetLineThickness(t.lineThickness),e.SetFlags(x.e_shapeBit|x.e_jointBit),this._debugDrawEnabled=!0,e}},{key:"refresh",value:function(t){p.prototype.refresh.call(this,t),this.update(t/1e3)}},{key:"update",value:function(t){this._control.update(),t=t||1/60,this._world.Step(t,4,3),this._debugDrawEnabled&&this._world.DrawDebugData(),this._world.ClearForces()}},{key:"setDirectControl",value:function(){var t,e,i,s,n=this._canvas.getBoundingClientRect(),o=this;return{turnOn:function(){document.addEventListener("mousedown",r,!0),document.addEventListener("touchstart",r,!0),document.addEventListener("mouseup",a,!0),document.addEventListener("touchend",a,!0)},turnOff:function(){i=!1,document.removeEventListener("mousedown",r,!0),document.removeEventListener("touchstart",r,!0),document.removeEventListener("mouseup",a,!0),document.removeEventListener("touchend",a,!0)},update:function(){if(i&&!s){var n=o.getBodyAt(t,e);if(n){var r=new Box2D.Dynamics.Joints.b2MouseJointDef;r.bodyA=o._world.GetGroundBody(),r.bodyB=n,r.target.Set(t,e),r.collideConnected=!0,r.maxForce=300*n.GetMass(),s=o._world.CreateJoint(r),n.SetAwake(!0)}}s&&(i?s.SetTarget(new w(t,e)):(o._world.DestroyJoint(s),s=null))}};function r(t){n=o._canvas.getBoundingClientRect(),i=!0,h(t),document.addEventListener("mousemove",h,!0),document.addEventListener("touchmove",h,!0)}function a(){document.removeEventListener("mousemove",h,!0),document.removeEventListener("touchmove",h,!0),i=!1,t=void 0,e=void 0}function h(i){var s,r,a;if(i.clientX)s=i.clientX,r=i.clientY;else{if(!(i.changedTouches&&i.changedTouches.length>0))return;var h=i.changedTouches[i.changedTouches.length-1];s=h.clientX,r=h.clientY}a=o.getCoordinateFrom(s-n.left,r-n.top),t=a.x/o.SCALE,e=a.y/o.SCALE,i.preventDefault()}}},{key:"getBodyList",value:function(){var t=[];return function e(i){i&&(t.push(i),e(i.GetNext()))}(this._world.GetBodyList()),t}},{key:"getBodyDetails",value:function(t){var e=["static","kinematic","dynamic"][t.GetType()],i=t.GetPosition(),s=[];return function t(e){if(e){var i=e.GetShape();s.push({type:e.GetType(),density:e.GetDensity(),friction:e.GetFriction(),shape:0===i.GetType()?{type:"circle",radius:i.GetRadius()}:{type:"polygon",points:(n=i.GetVertices(),n.map((function(t){return{x:t.x,y:t.y}})))}}),t(e.GetNext())}var n}(t.GetFixtureList()),{x:i.x,y:i.y,a:t.GetAngle(),type:e,data:t.GetUserData(),fixtures:s}}},{key:"getBodyAt",value:function(t,e){var i=new w(t,e),s=new B;s.lowerBound.Set(t-.001,e-.001),s.upperBound.Set(t+.001,e+.001);var n=null;return this._world.QueryAABB((function(t){if(t.GetBody().GetType()!==D.b2_staticBody&&t.GetShape().TestPoint(t.GetBody().GetTransform(),i))return n=t.GetBody(),!1;return!0}),s),n}},{key:"createBody",value:function(e,i,s){var n=this,o={s:D.b2_staticBody,static:D.b2_staticBody,k:D.b2_kinematicBody,kinematic:D.b2_kinematicBody,d:D.b2_dynamicBody,dynamic:D.b2_dynamicBody};i=i||[];var r=new S;r.type=o[e.type],r.position.x=e.x,r.position.y=e.y,void 0!==s&&(r.userData=s),"object"!==t(i)||i instanceof Array||(i=[i]);var a=this._world.CreateBody(r);return i.forEach((function(t){a.CreateFixture(n.createFixture(t))})),a}},{key:"createFixture",value:function(t){var e=new A;return e.density=t.density,e.friction=t.friction,e.restitution=t.restitution,e.shape=this.createShape(t.shape),e}},{key:"createShape",value:function(t){var e=new k;switch(t.type){case"box":e.SetAsBox(t.w/2,t.h/2);break;case"edge":e.SetAsEdge(new w(t.x1,t.y1),new w(t.x2,t.y2));break;case"circle":e=new T(t.r);break;default:var i=[];t.forEach((function(t){i.push(new w(t.x,t.y))})),e.SetAsArray(i,i.length)}return e}},{key:"addRevoluteJoint",value:function(t,e,i){var s=new E;return s.Initialize(t,e,t.GetWorldCenter()),i&&i.motorSpeed&&(s.motorSpeed=i.motorSpeed,s.maxMotorTorque=i.maxMotorTorque,s.enableMotor=i.enableMotor),this._world.CreateJoint(s)}},{key:"applyImpulse",value:function(t,e,i){t.ApplyImpulse(new w(Math.cos(e*(Math.PI/180))*i,Math.sin(e*(Math.PI/180))*i),t.GetWorldCenter())}}]),a}();function j(t,e,i){this.type=t.type||"d",this.density=t.density||1,this.friction=t.friction||0,this.restitution=t.restitution||0,this.scale=i;var s=this;this.addToWorld=function(t){var e=s.scale,i={x:s.x/e,y:s.y/e,type:s.type},n=s.shape,o={density:s.density,friction:s.friction,restitution:s.restitution,shape:n},r=s.data;s.body=(t||s.physics).createBody(i,o,r)},this.draw=function(){l.prototype.draw.call(s),s.update()},this.update=function(){var t=e.getBodyDetails(s.body);s.x=t.x*i,s.y=t.y*i,s.r=t.a},e&&(this.physics=e,this.addToWorld(e))}function G(t,e,i){t=t||{},y.call(this,t),this.shape={type:"circle",r:t.radius/i},j.call(this,t,e,i)}function L(t,e,i){t=t||{},f.call(this,t),this.shape={type:"box",w:t.width/i,h:t.height/i},j.call(this,t,e,i)}function I(t,e,i){t=t||{},v.call(this,t),this.shape=this.points.map((function(t){return{x:t.x/i,y:t.y/i}})),j.call(this,t,e,i)}function P(t,e,i){t=t||{},d.call(this,t),this.shape=this.points.map((function(t){return{x:t.x/i,y:t.y/i}})),j.call(this,t,e,i)}O.default={scale:30,gravity:9.8},j.prototype=Object.create(l.prototype),j.prototype.constructor=j,G.prototype=Object.create(y.prototype),G.prototype.constructor=G,L.prototype=Object.create(f.prototype),L.prototype.constructor=L,I.prototype=Object.create(v.prototype),I.prototype.constructor=I,P.prototype=Object.create(d.prototype),P.prototype.constructor=P,window.GraphyX={VERSION:"0.1",EventDispatcher:u,Engine:p,objects:{GraphicObject:l,Circle:y,Rect:f,Line:d,Polygon:v,Image:_},Physics:O,physicObjects:{PhysicObject:j,Circle:G,Rect:L,Polygon:I,Line:P},utility:C};
