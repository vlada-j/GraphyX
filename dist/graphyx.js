"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _possibleConstructorReturn(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?_assertThisInitialized(t):e}function _createSuper(i){var s=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(i);return _possibleConstructorReturn(this,s?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _get(t,e,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){t=_superPropBase(t,e);if(t){e=Object.getOwnPropertyDescriptor(t,e);return e.get?e.get.call(i):e.value}})(t,e,i||t)}var EventDispatcher=function(){function t(){_classCallCheck(this,t),this._listeners={}}return _createClass(t,[{key:"addEventListener",value:function(t,e){void 0===this._listeners[t]&&(this._listeners[t]=[]),-1===this._listeners[t].indexOf(e)&&this._listeners[t].push(e)}},{key:"hasEventListener",value:function(t,e){return void 0!==this._listeners[t]&&-1!==this._listeners[t].indexOf(e)}},{key:"removeEventListener",value:function(t,e){t=this._listeners[t];void 0===t||-1!==(e=t.indexOf(e))&&t.splice(e,1)}},{key:"dispatchEvent",value:function(t){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=e.slice(0),s=0,o=i.length;s<o;s++)i[s].call(this,t)}}}]),t}();function GraphicObject(t){this.sprite=t.sprite,this.fill=t.fill||"transparent",this.stroke=t.stroke||"transparent",this.line=t.line||1,this.x=t.x||0,this.y=t.y||0,this.r=t.r||0,this.opacity=t.opacity||1,this.shadow=t.shadow||!1}GraphicObject.prototype={constructor:GraphicObject,transform:function(t){this.sprite=t||this.sprite,this.sprite.translate(this.x,this.y),this.sprite.rotate(this.r),this.sprite.translate(-this.x,-this.y)},stylize:function(t){this.sprite=t||this.sprite,this.sprite.fillStyle=this.fill,this.sprite.strokeStyle=this.stroke,this.sprite.lineWidth=this.line,this.sprite.globalAlpha=this.opacity,this.shadow&&(this.sprite.shadowColor=this.shadow.color,this.sprite.shadowBlur=this.shadow.blur,this.sprite.shadowOffsetX=this.shadow.x,this.sprite.shadowOffsetY=this.shadow.y)},draw:function(t){this.sprite=t||this.sprite,null!==this.stroke&&this.sprite.stroke(),this.fill instanceof window.HTMLImageElement?(this.sprite.clip(),this.sprite.drawImage(this.fill,this.x-this.fill.width/2,this.y-this.fill.height/2)):null!==this.fill&&this.sprite.fill()},render:function(t){this.sprite=t||this.sprite,this.sprite.save(),this.transform(t),this.stylize(t),this.shaped(t),this.draw(t),this.sprite.restore()},shaped:function(){}};var Engine=function(){_inherits(s,EventDispatcher);var i=_createSuper(s);function s(t){var e;return _classCallCheck(this,s),(e=i.call(this))._settings=t,e._canvas=null,e._sprite=null,e.CANVAS_WIDTH=0,e.CANVAS_HEIGHT=0,e._zoom=1,e._pan={x:0,y:0},e._isRun=!1,e._lastTimestamp=0,e._fps=0,e._followingTarget=null,e._onUpdate=function(){},e.objects=[],e.init(),e}return _createClass(s,[{key:"init",value:function(){var t=this._settings,e="string"==typeof t.canvas?document.querySelector(t.canvas):t.canvas,i=e.getContext("2d");this.CANVAS_WIDTH=e.width,this.CANVAS_HEIGHT=e.height,this._zoom=t.zoom||this._zoom,this._pan={x:this.CANVAS_WIDTH/2,y:this.CANVAS_HEIGHT/2},this._settings=t,this._canvas=e,this._sprite=i,this._isRun=!1}},{key:"resize",value:function(t,e){this._canvas.width=this.CANVAS_WIDTH=t,this._canvas.height=this.CANVAS_HEIGHT=e,this._pan={x:t/2,y:e/2}}},{key:"start",value:function(){this._isRun||(this._isRun=!0,this._lastTimestamp=(new Date).getTime(),this.loop())}},{key:"stop",value:function(){this._isRun=!1}},{key:"loop",value:function(){var t=this,e=(new Date).getTime(),i=e-this._lastTimestamp;this._fps=parseInt(1e3/i),this._lastTimestamp=e,this._isRun&&window.requestAnimationFrame(function(){t.loop.call(t)}),this.refresh(i)}},{key:"onUpdate",value:function(t){var e=this._onUpdate;this._onUpdate=function(){e(),"function"==typeof t&&t()}}},{key:"draw",value:function(){var e=this;e.objects instanceof Array&&e.objects.forEach(function(t){t instanceof GraphicObject&&t.render(e._sprite)})}},{key:"clear",value:function(){this._sprite.setTransform(1,0,0,1,0,0),"number"==typeof this._fade?(this._sprite.fillStyle="rgba(0,0,0,"+this._fade+")",this._sprite.beginPath(),this._sprite.fillRect(0,0,this.CANVAS_WIDTH,this.CANVAS_WIDTH),this._sprite.closePath(),this._sprite.fill()):this._sprite.clearRect(0,0,this.CANVAS_WIDTH,this.CANVAS_WIDTH),this._followingTarget&&(this._pan.x=this._canvas.width/2-this._followingTarget.x*this._zoom,this._pan.y=this._canvas.height/2-this._followingTarget.y*this._zoom),this._sprite.translate(this._pan.x,this._pan.y),this._sprite.scale(this._zoom,this._zoom)}},{key:"refresh",value:function(t){this.clear(),this.draw(),this.dispatchEvent({type:"update",target:this,delta:t||0,fps:this._fps})}},{key:"scroll",value:function(t,e){if(void 0===t&&void 0===e)return this._pan;"number"==typeof t&&(this._pan.x=t),"number"==typeof e&&(this._pan.y=e),this._isRun||this.refresh()}},{key:"following",value:function(t){if(null===t&&(this._followingTarget=null),!(t instanceof GraphicObject)&&"number"!=typeof t)return this._followingTarget;"number"==typeof t&&(t=this.objects[t]),this._followingTarget=t}},{key:"zoom",value:function(t){if(void 0===t)return 100*this._zoom;this._zoom=t/100||this._zoom,this._isRun||this.refresh()}},{key:"getCoordinateFrom",value:function(t,e){var i=this._zoom;return{x:(t-this._pan.x)/i,y:(e-this._pan.y)/i}}},{key:"getPixel",value:function(t,e){e=this._sprite.getImageData(t,e,1,1).data;return{r:e[0],g:e[1],b:e[2],a:e[3]}}}]),s}();function Circle(t){t=t||{},this.radius=t.radius||10,GraphicObject.call(this,t)}function Rect(t){t=t||{},this.width=t.width||20,this.height=t.height||10,GraphicObject.call(this,t)}function Line(t){t=t||{},this.points=t.points||[],GraphicObject.call(this,t),this.fill=null}function Polygon(t){t=t||{},this.points=t.points||[],Line.call(this,t),this.fill=t.fill}function Image$1(t){t=t||{},this.width=t.width||10,this.height=t.height||10,GraphicObject.call(this,t),t.src instanceof window.HTMLImageElement?this.img=t.src:(this.img=new window.Image(this.width,this.height),this.img.src=t.src||"")}function extend(t,e,i){for(var s in t=t||{},e=e||{})e.hasOwnProperty(s)&&(t[s]=isPlainObject(e[s])?extend(t[s],e[s]):(void 0===e[s]?t:e)[s]);return i&&extend(t,i),t}function isPlainObject(t){return"object"===_typeof(t)&&null!==t&&t.constructor===Object&&"[object Object]"===Object.prototype.toString.call(t)}function imagesLoader(s,o,n){o=o||function(){},n=n||function(){};var r,a={};return(s=s||{})instanceof Array&&(s.forEach(function(t){a[t]=t}),s=a,a={}),r=Object.keys(s).length,Object.keys(s).forEach(function(t){var e=new Image,i=s[t];e.onload=function(){a[t]=e,0===--r&&o(a)},e.onerror=n,e.src=i}),a}Circle.prototype=Object.create(GraphicObject.prototype),(Circle.prototype.constructor=Circle).prototype.shaped=function(t){this.sprite=t||this.sprite,this.sprite.beginPath(),this.sprite.arc(this.x,this.y,this.radius,0,2*Math.PI),this.sprite.closePath()},Rect.prototype=Object.create(GraphicObject.prototype),(Rect.prototype.constructor=Rect).prototype.shaped=function(t){this.sprite=t||this.sprite,this.sprite.beginPath(),this.sprite.rect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),this.sprite.closePath()},Line.prototype=Object.create(GraphicObject.prototype),(Line.prototype.constructor=Line).prototype.shaped=function(t){this.sprite=t||this.sprite;var e=this.points;this.sprite.beginPath(),this.sprite.moveTo(this.x+e[0].x,this.y+e[0].y);for(var i=1;i<e.length;i++)this.sprite.lineTo(e[i].x+this.x,e[i].y+this.y)},Polygon.prototype=Object.create(Line.prototype),(Polygon.prototype.constructor=Polygon).prototype.shaped=function(t){this.sprite=t||this.sprite,Line.prototype.shaped.call(this),this.sprite.closePath()},Image$1.prototype=Object.create(GraphicObject.prototype),(Image$1.prototype.constructor=Image$1).prototype.shaped=function(t){this.sprite=t||this.sprite,this.sprite.drawImage(this.img,this.x-this.img.width/2,this.y-this.img.height/2,this.width,this.height)};var b2Vec2,b2World,b2DebugDraw,b2Body,b2BodyDef,b2FixtureDef,b2PolygonShape,b2CircleShape,b2AABB,b2RevoluteJointDef,utility={extend:extend,isPlainObject:isPlainObject,imagesLoader:imagesLoader};function importBox2D(){b2Vec2=Box2D.Common.Math.b2Vec2,b2World=Box2D.Dynamics.b2World,b2DebugDraw=Box2D.Dynamics.b2DebugDraw,b2Body=Box2D.Dynamics.b2Body,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2AABB=Box2D.Collision.b2AABB,b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef}var Physics=function(){_inherits(i,Engine);var e=_createSuper(i);function i(t){return _classCallCheck(this,i),importBox2D(),t=extend({},i.default,t),(t=e.call(this,t)).CANVAS_WIDTH,t.CANVAS_HEIGHT,t.SCALE,t._isRun=!1,t._world,t._boundaries,t._debugDraw,t._control,t}return _createClass(i,[{key:"init",value:function(){_get(_getPrototypeOf(i.prototype),"init",this).call(this);var t,e=this._settings;t="object"===_typeof(t=e.gravity)?t:{x:0,y:t},t=new b2Vec2(t.x,t.y),this.SCALE=e.scale,this._settings=e,this._gravity=t,this._isRun=!1,this._debugDrawEnabled=!!e.debugDraw,this._control=this.setDirectControl(),this._control[e.directControl?"turnOn":"turnOff"]()}},{key:"createWorld",value:function(){this._world=new b2World(this._gravity,!0),this._debugDrawEnabled&&(this._debugDraw=this.createDebugDraw({sprite:this._sprite,scale:this.SCALE,alpha:.5,lineThickness:1}),this._world.SetDebugDraw(this._debugDraw))}},{key:"createWorldBoundaries",value:function(t,e){t=(t||this._canvas.width)/this.SCALE,e=(e||this._canvas.height)/this.SCALE,this._boundaries=this.createBody({x:-t/2,y:-e/2,type:"s"},[{friction:1,shape:{type:"edge",x1:0,y1:0,x2:t,y2:0}},{friction:1,shape:{type:"edge",x1:0,y1:e,x2:t,y2:e}},{friction:1,shape:{type:"edge",x1:0,y1:0,x2:0,y2:e}},{friction:1,shape:{type:"edge",x1:t,y1:0,x2:t,y2:e}}])}},{key:"createDebugDraw",value:function(t){var e=new b2DebugDraw;return e.SetSprite(t.sprite),e.SetDrawScale(t.scale),e.SetFillAlpha(t.alpha),e.SetLineThickness(t.lineThickness),e.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),this._debugDrawEnabled=!0,e}},{key:"refresh",value:function(t){Engine.prototype.refresh.call(this,t),this.update(t/1e3)}},{key:"update",value:function(t){this._control.update(),t=t||1/60,this._world.Step(t,4,3),this._debugDrawEnabled&&this._world.DrawDebugData(),this._world.ClearForces()}},{key:"setDirectControl",value:function(){var o,n,i,s,r=this._canvas.getBoundingClientRect(),a=this;return{turnOn:function(){document.addEventListener("mousedown",t,!0),document.addEventListener("touchstart",t,!0),document.addEventListener("mouseup",e,!0),document.addEventListener("touchend",e,!0)},turnOff:function(){i=!1,document.removeEventListener("mousedown",t,!0),document.removeEventListener("touchstart",t,!0),document.removeEventListener("mouseup",e,!0),document.removeEventListener("touchend",e,!0)},update:function(){{var t,e;!i||s||(t=a.getBodyAt(o,n))&&((e=new Box2D.Dynamics.Joints.b2MouseJointDef).bodyA=a._world.GetGroundBody(),e.bodyB=t,e.target.Set(o,n),e.collideConnected=!0,e.maxForce=300*t.GetMass(),s=a._world.CreateJoint(e),t.SetAwake(!0))}s&&(i?s.SetTarget(new b2Vec2(o,n)):(a._world.DestroyJoint(s),s=null))}};function t(t){r=a._canvas.getBoundingClientRect(),i=!0,c(t),document.addEventListener("mousemove",c,!0),document.addEventListener("touchmove",c,!0)}function e(){document.removeEventListener("mousemove",c,!0),document.removeEventListener("touchmove",c,!0),i=!1,n=o=void 0}function c(t){if(t.clientX)i=t.clientX,s=t.clientY;else{if(!(t.changedTouches&&0<t.changedTouches.length))return;var e=t.changedTouches[t.changedTouches.length-1],i=e.clientX,s=e.clientY}s=a.getCoordinateFrom(i-r.left,s-r.top),o=s.x/a.SCALE,n=s.y/a.SCALE,t.preventDefault()}}},{key:"getBodyList",value:function(){var i=[];return function t(e){e&&(i.push(e),t(e.GetNext()))}(this._world.GetBodyList()),i}},{key:"getBodyDetails",value:function(t){var e=["static","kinematic","dynamic"][t.GetType()],i=t.GetPosition(),s=[];return function t(e){{var i;e&&(i=e.GetShape(),s.push({type:e.GetType(),density:e.GetDensity(),friction:e.GetFriction(),shape:0===i.GetType()?{type:"circle",radius:i.GetRadius()}:{type:"polygon",points:function(t){return t.map(function(t){return{x:t.x,y:t.y}})}(i.GetVertices())}}),t(e.GetNext()))}}(t.GetFixtureList()),{x:i.x,y:i.y,a:t.GetAngle(),type:e,data:t.GetUserData(),fixtures:s}}},{key:"getBodyAt",value:function(t,e){var i=new b2Vec2(t,e),s=new b2AABB;s.lowerBound.Set(t-.001,e-.001),s.upperBound.Set(t+.001,e+.001);var o=null;return this._world.QueryAABB(function(t){if(t.GetBody().GetType()!==b2Body.b2_staticBody&&t.GetShape().TestPoint(t.GetBody().GetTransform(),i))return o=t.GetBody(),!1;return!0},s),o}},{key:"createBody",value:function(t,e,i){var s=this,o={s:b2Body.b2_staticBody,static:b2Body.b2_staticBody,k:b2Body.b2_kinematicBody,kinematic:b2Body.b2_kinematicBody,d:b2Body.b2_dynamicBody,dynamic:b2Body.b2_dynamicBody};e=e||[];var n=new b2BodyDef;n.type=o[t.type],n.position.x=t.x,n.position.y=t.y,void 0!==i&&(n.userData=i),"object"!==_typeof(e)||e instanceof Array||(e=[e]);var r=this._world.CreateBody(n);return e.forEach(function(t){r.CreateFixture(s.createFixture(t))}),r}},{key:"createFixture",value:function(t){var e=new b2FixtureDef;return e.density=t.density,e.friction=t.friction,e.restitution=t.restitution,e.shape=this.createShape(t.shape),e}},{key:"createShape",value:function(t){var e=new b2PolygonShape;switch(t.type){case"box":e.SetAsBox(t.w/2,t.h/2);break;case"edge":e.SetAsEdge(new b2Vec2(t.x1,t.y1),new b2Vec2(t.x2,t.y2));break;case"circle":e=new b2CircleShape(t.r);break;default:var i=[];t.forEach(function(t){i.push(new b2Vec2(t.x,t.y))}),e.SetAsArray(i,i.length)}return e}},{key:"addRevoluteJoint",value:function(t,e,i){var s=new b2RevoluteJointDef;return s.Initialize(t,e,t.GetWorldCenter()),i&&i.motorSpeed&&(s.motorSpeed=i.motorSpeed,s.maxMotorTorque=i.maxMotorTorque,s.enableMotor=i.enableMotor),this._world.CreateJoint(s)}},{key:"applyImpulse",value:function(t,e,i){t.ApplyImpulse(new b2Vec2(Math.cos(e*(Math.PI/180))*i,Math.sin(e*(Math.PI/180))*i),t.GetWorldCenter())}}]),i}();function PhysicObject(t,e,i){this.type=t.type||"d",this.density=t.density||1,this.friction=t.friction||0,this.restitution=t.restitution||0,this.scale=i;var o=this;this.addToWorld=function(t){var e=o.scale,i={x:o.x/e,y:o.y/e,type:o.type},s=o.shape,e={density:o.density,friction:o.friction,restitution:o.restitution,shape:s},s=o.data;o.body=(t||o.physics).createBody(i,e,s)},this.draw=function(){GraphicObject.prototype.draw.call(o),o.update()},this.update=function(){var t=e.getBodyDetails(o.body);o.x=t.x*i,o.y=t.y*i,o.r=t.a},e&&(this.physics=e,this.addToWorld(e))}function Circle$1(t,e,i){t=t||{},Circle.call(this,t),this.shape={type:"circle",r:t.radius/i},PhysicObject.call(this,t,e,i)}function Rect$1(t,e,i){t=t||{},Rect.call(this,t),this.shape={type:"box",w:t.width/i,h:t.height/i},PhysicObject.call(this,t,e,i)}function Polygon$1(t,e,i){t=t||{},Polygon.call(this,t),this.shape=this.points.map(function(t){return{x:t.x/i,y:t.y/i}}),PhysicObject.call(this,t,e,i)}function Line$1(t,e,i){t=t||{},Line.call(this,t),this.shape=this.points.map(function(t){return{x:t.x/i,y:t.y/i}}),PhysicObject.call(this,t,e,i)}Physics.default={scale:30,gravity:9.8},PhysicObject.prototype=Object.create(GraphicObject.prototype),PhysicObject.prototype.constructor=PhysicObject,Circle$1.prototype=Object.create(Circle.prototype),Circle$1.prototype.constructor=Circle$1,Rect$1.prototype=Object.create(Rect.prototype),Rect$1.prototype.constructor=Rect$1,Polygon$1.prototype=Object.create(Polygon.prototype),Polygon$1.prototype.constructor=Polygon$1,Line$1.prototype=Object.create(Line.prototype),Line$1.prototype.constructor=Line$1,window.GraphyX={VERSION:"0.1",EventDispatcher:EventDispatcher,Engine:Engine,objects:{GraphicObject:GraphicObject,Circle:Circle,Rect:Rect,Line:Line,Polygon:Polygon,Image:Image$1},Physics:Physics,physicObjects:{PhysicObject:PhysicObject,Circle:Circle$1,Rect:Rect$1,Polygon:Polygon$1,Line:Line$1},utility:utility};
